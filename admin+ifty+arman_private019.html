<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Bookings Admin</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-950 text-white min-h-screen">

<header class="sticky top-0 z-10 bg-slate-950/80 backdrop-blur border-b border-white/10">
  <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="h-10 w-10 rounded-2xl bg-gradient-to-br from-emerald-400 to-cyan-400"></div>
      <div>
        <p class="text-sm text-white/70">Admin</p>
        <p class="font-semibold">Bookings</p>
      </div>
    </div>

    <div class="flex gap-3">
      <a href="index.html" class="px-4 py-2 rounded-xl border border-white/20 hover:bg-white/10 text-sm">
        New booking
      </a>
      <button id="refreshBtn" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-sm">
        Refresh
      </button>
    </div>
  </div>
</header>

<main class="max-w-7xl mx-auto px-6 py-10">

  <!-- Header Stats -->
  <div class="flex flex-col md:flex-row justify-between gap-6">
    <div>
      <h1 class="text-3xl font-bold">Booking Information</h1>
      <p class="text-white/60 mt-2">Auto-refresh every 5 seconds.</p>
    </div>

    <div class="flex gap-4">
      <div class="bg-white/5 border border-white/10 rounded-2xl px-6 py-4">
        <p class="text-xs text-white/60">Total bookings</p>
        <p id="countText" class="text-xl font-semibold">0</p>
      </div>
      <div class="bg-white/5 border border-white/10 rounded-2xl px-6 py-4">
        <p class="text-xs text-white/60">Last update</p>
        <p id="lastUpdateText" class="text-xl font-semibold">—</p>
      </div>
    </div>
  </div>

  <!-- Desktop Table -->
  <div class="hidden md:block mt-10 bg-white/5 border border-white/10 rounded-3xl overflow-hidden">
    <table class="w-full text-sm">
      <thead class="bg-white/5 text-white/80">
        <tr>
          <th class="px-4 py-4 text-left">Created</th>
          <th class="px-4 py-4 text-left">Shooting Date</th>
          <th class="px-4 py-4 text-left">Client Details</th>
          <th class="px-4 py-4 text-left">Package</th>
          <th class="px-4 py-4 text-left">Add-ons</th>
          <th class="px-4 py-4 text-left">Total</th>
          <th class="px-4 py-4 text-left">Status</th>
          <th class="px-4 py-4 text-left">Actions</th>
        </tr>
      </thead>
      <tbody id="tableRows" class="divide-y divide-white/10"></tbody>
    </table>
  </div>

  <!-- Mobile Cards -->
  <div id="mobileCards" class="md:hidden mt-8 space-y-4"></div>

  <p id="errorText" class="mt-6 text-rose-400 text-sm"></p>

</main>

<script>
const tableRows = document.getElementById("tableRows");
const mobileCards = document.getElementById("mobileCards");
const countText = document.getElementById("countText");
const lastUpdateText = document.getElementById("lastUpdateText");
const errorText = document.getElementById("errorText");
const refreshBtn = document.getElementById("refreshBtn");

function formatDate(value){
  if(!value) return "—";
  return new Date(value).toLocaleString();
}

function addonSummary(b){
  const parts = [];
  if(b.addon_extra_edit === "yes") parts.push(`Extra edit (${b.extra_edit_qty})`);
  if(b.addon_video === "yes") parts.push("Video reel");
  if(b.addon_express === "yes") parts.push("Express delivery");
  if(b.addon_travel_outside === "yes") parts.push("Travel outside city");
  return parts.length ? parts.join(", ") : "None";
}

function statusBadge(status){
  const map = {
    Pending: "bg-yellow-500/20 text-yellow-300 border-yellow-400/40",
    Done: "bg-emerald-500/20 text-emerald-300 border-emerald-400/40",
    Cancelled: "bg-rose-500/20 text-rose-300 border-rose-400/40"
  };
  return `<span class="px-3 py-1 text-xs rounded-full border ${map[status] || map.Pending}">
    ${status}
  </span>`;
}

async function updateStatus(id, status) {
  try {
    const res = await fetch("/.netlify/functions/update-status", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id, status })
    });

    const out = await res.json();

    if (!res.ok) {
      throw new Error(out.error || "Update failed");
    }

    load(); // reload bookings
  } catch (err) {
    alert("Status update failed: " + err.message);
  }
}

async function load(){
  try{
    const res = await fetch("/.netlify/functions/list-bookings");
    const data = await res.json();
    const bookings = data.bookings || [];

    countText.textContent = bookings.length;
    lastUpdateText.textContent = new Date().toLocaleTimeString();

    tableRows.innerHTML = "";
    mobileCards.innerHTML = "";

    bookings.forEach(b => {

      // Desktop Row
      const tr = document.createElement("tr");
      tr.className = "hover:bg-white/5 transition";
      tr.innerHTML = `
        <td class="px-4 py-4">${formatDate(b.created_at)}</td>
        <td class="px-4 py-4">${formatDate(b.shooting_datetime)}</td>
        <td class="px-4 py-4">
          <div class="font-semibold">${b.name}</div>
          <div class="text-white/60 text-xs">${b.phone}</div>
          <div class="text-white/60 text-xs">${b.email}</div>
          <div class="text-white/50 text-xs">${b.address}</div>
        </td>
        <td class="px-4 py-4">${b.package_name}</td>
        <td class="px-4 py-4 text-white/70">${addonSummary(b)}</td>
        <td class="px-4 py-4 font-bold text-emerald-300">
          £${Number(b.total_price).toFixed(0)}
        </td>
        <td class="px-4 py-4">${statusBadge(b.status)}</td>
        <td class="px-4 py-4 space-x-2">
          <button onclick="updateStatus('${b.id}','Done')" 
            class="px-3 py-1 text-xs rounded-lg bg-emerald-500/20 hover:bg-emerald-500/40">
            Done
          </button>
          <button onclick="updateStatus('${b.id}','Cancelled')" 
            class="px-3 py-1 text-xs rounded-lg bg-rose-500/20 hover:bg-rose-500/40">
            Cancel
          </button>
        </td>
      `;
      tableRows.appendChild(tr);

      // Mobile Card
      const card = document.createElement("div");
      card.className = "bg-white/5 border border-white/10 rounded-2xl p-5";
      card.innerHTML = `
        <div class="flex justify-between">
          <div>
            <p class="font-semibold">${b.name}</p>
            <p class="text-white/60 text-sm">${b.phone}</p>
            <p class="text-white/60 text-sm">${b.email}</p>
          </div>
          ${statusBadge(b.status)}
        </div>

        <div class="mt-3 text-sm text-white/70 space-y-1">
          <div><span class="text-white/50">Address:</span> ${b.address}</div>
          <div><span class="text-white/50">Shooting:</span> ${formatDate(b.shooting_datetime)}</div>
          <div><span class="text-white/50">Package:</span> ${b.package_name}</div>
          <div><span class="text-white/50">Add-ons:</span> ${addonSummary(b)}</div>
          <div><span class="text-white/50">Total:</span> £${Number(b.total_price).toFixed(0)}</div>
        </div>

        <div class="mt-4 flex gap-3">
          <button onclick="updateStatus('${b.id}','Done')" 
            class="flex-1 px-3 py-2 text-sm rounded-xl bg-emerald-500/20 hover:bg-emerald-500/40">
            Done
          </button>
          <button onclick="updateStatus('${b.id}','Cancelled')" 
            class="flex-1 px-3 py-2 text-sm rounded-xl bg-rose-500/20 hover:bg-rose-500/40">
            Cancel
          </button>
        </div>
      `;
      mobileCards.appendChild(card);

    });

  }catch(err){
    errorText.textContent = "Failed to load bookings.";
  }
}

refreshBtn.addEventListener("click", load);
load();
setInterval(load, 5000);
</script>

</body>
</html>
