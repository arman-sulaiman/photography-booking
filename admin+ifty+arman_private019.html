<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Bookings Admin</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-950 text-white min-h-screen">

<header class="sticky top-0 z-10 bg-slate-950/80 backdrop-blur border-b border-white/10">
  <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="h-10 w-10 rounded-2xl bg-gradient-to-br from-emerald-400 to-cyan-400"></div>
      <div>
        <p class="text-sm text-white/70">Admin</p>
        <p class="font-semibold">Bookings</p>
      </div>
    </div>

    <div class="flex items-center gap-3">
      <a href="index.html" class="text-sm px-4 py-2 rounded-xl border border-white/15 hover:bg-white/5 transition">
        New booking
      </a>
      <button id="refreshBtn" class="text-sm px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20 transition">
        Refresh
      </button>
    </div>
  </div>
</header>

<main class="max-w-7xl mx-auto px-6 py-10">

  <!-- Header -->
  <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-6">
    <div>
      <h1 class="text-3xl font-bold">Booking Information</h1>
      <p class="text-white/60 mt-2">Auto-refresh every 5 seconds.</p>
    </div>

    <div class="flex gap-4">
      <div class="rounded-2xl border border-white/10 bg-white/5 px-6 py-4">
        <p class="text-xs text-white/60">Total bookings</p>
        <p id="countText" class="text-xl font-semibold">0</p>
      </div>
      <div class="rounded-2xl border border-white/10 bg-white/5 px-6 py-4">
        <p class="text-xs text-white/60">Last update</p>
        <p id="lastUpdateText" class="text-xl font-semibold">‚Äî</p>
      </div>
    </div>
  </div>

  <!-- DESKTOP TABLE -->
  <div class="hidden md:block mt-10 bg-white/5 border border-white/10 rounded-3xl overflow-hidden shadow-xl">
    <table class="w-full text-sm">
      <thead class="bg-white/5 text-white/80">
        <tr>
          <th class="px-5 py-4 text-left">Created</th>
          <th class="px-5 py-4 text-left">Shoot Date</th>
          <th class="px-5 py-4 text-left">Client</th>
          <th class="px-5 py-4 text-left">Package</th>
          <th class="px-5 py-4 text-left">Total</th>
          <th class="px-5 py-4 text-left">Status</th>
          <th class="px-5 py-4 text-left">Actions</th>
        </tr>
      </thead>
      <tbody id="tableRows" class="divide-y divide-white/10"></tbody>
    </table>
  </div>

  <!-- MOBILE CARD VIEW -->
  <div id="mobileCards" class="md:hidden mt-8 space-y-4"></div>

  <p id="errorText" class="mt-6 text-rose-400 text-sm"></p>

</main>

<script>
const tableRows = document.getElementById("tableRows");
const mobileCards = document.getElementById("mobileCards");
const countText = document.getElementById("countText");
const lastUpdateText = document.getElementById("lastUpdateText");
const errorText = document.getElementById("errorText");
const refreshBtn = document.getElementById("refreshBtn");

function formatDate(iso){
  if(!iso) return "‚Äî";
  const d = new Date(iso);
  return d.toLocaleString();
}

function statusBadge(status){
  const colors = {
    Pending: "bg-yellow-500/20 text-yellow-300 border-yellow-400/40",
    Done: "bg-emerald-500/20 text-emerald-300 border-emerald-400/40",
    Cancelled: "bg-rose-500/20 text-rose-300 border-rose-400/40"
  };
  return `<span class="px-3 py-1 text-xs rounded-full border ${colors[status] || colors.Pending}">
    ${status}
  </span>`;
}

async function updateStatus(id, status){
  await fetch("/.netlify/functions/update-status", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({id, status})
  });
  load();
}

async function load(){
  errorText.textContent = "";
  try{
    const res = await fetch("/.netlify/functions/list-bookings");
    const data = await res.json();
    const bookings = data.bookings || [];

    countText.textContent = bookings.length;
    lastUpdateText.textContent = new Date().toLocaleTimeString();

    tableRows.innerHTML = "";
    mobileCards.innerHTML = "";

    bookings.forEach(b => {

      // Desktop Row
      const tr = document.createElement("tr");
      tr.className = "hover:bg-white/5 transition";
      tr.innerHTML = `
        <td class="px-5 py-4">${formatDate(b.created_at)}</td>
        <td class="px-5 py-4">${formatDate(b.shooting_datetime)}</td>
        <td class="px-5 py-4 font-semibold">${b.name}</td>
        <td class="px-5 py-4">${b.package_name}</td>
        <td class="px-5 py-4 font-bold text-emerald-300">¬£${Number(b.total_price).toFixed(0)}</td>
        <td class="px-5 py-4">${statusBadge(b.status)}</td>
        <td class="px-5 py-4 space-x-2">
          <button onclick="updateStatus(${b.id}, 'Done')" 
            class="px-3 py-1 text-xs rounded-lg bg-emerald-500/20 hover:bg-emerald-500/40 transition">
            Done
          </button>
          <button onclick="updateStatus(${b.id}, 'Cancelled')" 
            class="px-3 py-1 text-xs rounded-lg bg-rose-500/20 hover:bg-rose-500/40 transition">
            Cancel
          </button>
        </td>
      `;
      tableRows.appendChild(tr);

      // Mobile Card
      const card = document.createElement("div");
      card.className = "bg-white/5 border border-white/10 rounded-2xl p-5";
      card.innerHTML = `
        <div class="flex justify-between items-start">
          <div>
            <p class="font-semibold">${b.name}</p>
            <p class="text-white/60 text-sm">${b.package_name}</p>
          </div>
          ${statusBadge(b.status)}
        </div>
        <div class="mt-3 text-sm text-white/70">
          üìÖ ${formatDate(b.shooting_datetime)}<br>
          üí∞ ¬£${Number(b.total_price).toFixed(0)}
        </div>
        <div class="mt-4 flex gap-3">
          <button onclick="updateStatus(${b.id}, 'Done')" 
            class="flex-1 px-3 py-2 text-sm rounded-xl bg-emerald-500/20">
            Done
          </button>
          <button onclick="updateStatus(${b.id}, 'Cancelled')" 
            class="flex-1 px-3 py-2 text-sm rounded-xl bg-rose-500/20">
            Cancel
          </button>
        </div>
      `;
      mobileCards.appendChild(card);
    });

  }catch(err){
    errorText.textContent = "‚ùå Failed to load bookings";
  }
}

refreshBtn.addEventListener("click", load);
load();
setInterval(load, 5000);
</script>

</body>
</html>
